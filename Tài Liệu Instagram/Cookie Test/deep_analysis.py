#!/usr/bin/env python3
"""
Deep Instagram Cookie Analysis
Ph√¢n t√≠ch s√¢u c√°c file preferences ƒë·ªÉ t√¨m session cookies
"""

import subprocess
import re
import json

def run_cmd(cmd: list[str], timeout: float = 30.0) -> str:
    try:
        out = subprocess.check_output(cmd, stderr=subprocess.STDOUT, text=True, timeout=timeout)
        return out.strip()
    except Exception as e:
        return str(e)

def analyze_key_preference_files(udid: str):
    """Ph√¢n t√≠ch c√°c file preferences quan tr·ªçng"""
    print(f"üîç PH√ÇN T√çCH S√ÇU PREFERENCE FILES CHO: {udid}")
    print("=" * 70)
    
    # C√°c file quan tr·ªçng c·∫ßn ki·ªÉm tra
    key_files = [
        "77231320408_USER_PREFERENCES.xml",
        "com.instagram.android_preferences.xml", 
        "AuthHeaderPrefs.xml",
        "PasswordEncryptionKeyStorePrefs.xml",
        "77231320408_trusted_device.xml",
        "waterfall_log_in.xml",
        "msys-preferences.xml"
    ]
    
    prefs_path = "/data/data/com.instagram.android/shared_prefs"
    
    for file_name in key_files:
        print(f"\nüìÑ Analyzing: {file_name}")
        print("-" * 50)
        
        # ƒê·ªçc to√†n b·ªô file
        read_cmd = f"""su -c "cat {prefs_path}/{file_name}" """
        file_content = run_cmd(["adb", "-s", udid, "shell", read_cmd], timeout=15)
        
        if "No such file" in file_content or len(file_content.strip()) < 10:
            print("   ‚ùå File kh√¥ng t·ªìn t·∫°i ho·∫∑c r·ªóng")
            continue
            
        print(f"   üìè File size: {len(file_content)} characters")
        
        # T√¨m c√°c pattern c√≥ th·ªÉ ch·ª©a session data
        session_patterns = [
            r'sessionid["\s]*[>=:]["\s]*([a-zA-Z0-9%]{20,})',
            r'session["\s]*[>=:]["\s]*([a-zA-Z0-9%]{20,})',
            r'csrftoken["\s]*[>=:]["\s]*([a-zA-Z0-9]{20,})',
            r'csrf["\s]*[>=:]["\s]*([a-zA-Z0-9]{20,})',
            r'ds_user_id["\s]*[>=:]["\s]*(\d{8,})',
            r'user_id["\s]*[>=:]["\s]*(\d{8,})',
            r'authorization["\s]*[>=:]["\s]*([a-zA-Z0-9%]{30,})',
            r'auth_token["\s]*[>=:]["\s]*([a-zA-Z0-9%]{30,})',
            r'access_token["\s]*[>=:]["\s]*([a-zA-Z0-9%]{30,})',
            r'Bearer\s+([a-zA-Z0-9%]{30,})',
            r'ig_session["\s]*[>=:]["\s]*([a-zA-Z0-9%]{20,})',
            r'cookie["\s]*[>=:]["\s]*([^"]{20,})',
            r'username["\s]*[>=:]["\s]*([a-zA-Z0-9._]{3,30})'
        ]
        
        found_matches = []
        for pattern in session_patterns:
            matches = re.findall(pattern, file_content, re.IGNORECASE)
            for match in matches:
                if len(str(match)) > 10:  # Ch·ªâ l·∫•y gi√° tr·ªã c√≥ √Ω nghƒ©a
                    found_matches.append((pattern.split('[')[0], match))
        
        if found_matches:
            print("   ‚úÖ T√¨m th·∫•y d·ªØ li·ªáu quan tr·ªçng:")
            for pattern_name, value in found_matches:
                # ·∫®n m·ªôt ph·∫ßn gi√° tr·ªã ƒë·ªÉ b·∫£o m·∫≠t
                display_value = str(value)[:10] + "..." if len(str(value)) > 10 else str(value)
                print(f"      üîë {pattern_name}: {display_value}")
        else:
            print("   ‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y session data")
            
        # T√¨m ki·∫øm JSON structures
        json_patterns = re.findall(r'\{[^}]{50,}\}', file_content)
        if json_patterns:
            print(f"   üìä T√¨m th·∫•y {len(json_patterns)} JSON structures")
            for i, json_str in enumerate(json_patterns[:3]):  # Ch·ªâ hi·ªÉn th·ªã 3 c√°i ƒë·∫ßu
                if any(keyword in json_str.lower() for keyword in ['session', 'token', 'auth', 'user']):
                    print(f"      üîç JSON {i+1}: {json_str[:100]}...")
        
        # T√¨m c√°c string c√≥ th·ªÉ l√† cookies/tokens
        long_strings = re.findall(r'[a-zA-Z0-9%]{40,}', file_content)
        if long_strings:
            print(f"   üéØ T√¨m th·∫•y {len(long_strings)} chu·ªói d√†i (c√≥ th·ªÉ l√† tokens)")
            for i, long_str in enumerate(long_strings[:3]):
                print(f"      #{i+1}: {long_str[:20]}...")

def extract_webview_cookies_advanced(udid: str):
    """Ph√¢n t√≠ch WebView cookies v·ªõi nhi·ªÅu ph∆∞∆°ng ph√°p"""
    print(f"\nüåê PH√ÇN T√çCH WEBVIEW COOKIES CHO: {udid}")
    print("=" * 70)
    
    webview_paths = [
        "/data/data/com.instagram.android/app_webview/Default/Cookies",
        "/data/data/com.instagram.android/app_webview/Cookies",
        "/data/data/com.instagram.android/app_chrome/Default/Cookies",
        "/data/data/com.instagram.android/app_ChromiumCookieStore/Cookies"
    ]
    
    for path in webview_paths:
        print(f"\nüìÇ Checking: {path}")
        
        # Ki·ªÉm tra file t·ªìn t·∫°i
        exists = run_cmd(["adb", "-s", udid, "shell", "su", "-c", f"test -f {path} && echo 'exists' || echo 'not found'"], timeout=5)
        
        if "exists" not in exists:
            print("   ‚ùå File kh√¥ng t·ªìn t·∫°i")
            continue
            
        # L·∫•y th√¥ng tin file
        file_info = run_cmd(["adb", "-s", udid, "shell", "su", "-c", f"ls -la {path}"], timeout=5)
        print(f"   üìä File info: {file_info}")
        
        # Copy file ƒë·ªÉ ph√¢n t√≠ch
        temp_path = "/sdcard/temp_cookies_analysis.db"
        copy_result = run_cmd(["adb", "-s", udid, "shell", "su", "-c", f"cp '{path}' {temp_path}"], timeout=10)
        run_cmd(["adb", "-s", udid, "shell", "su", "-c", f"chmod 644 {temp_path}"], timeout=5)
        
        # Ph∆∞∆°ng ph√°p 1: SQLite queries
        print("   üîç Method 1: SQLite queries...")
        sqlite_commands = [
            f"""su -c "sqlite3 {temp_path} 'SELECT name, value, host_key FROM cookies WHERE host_key LIKE \"%instagram%\" LIMIT 10;'" """,
            f"""su -c "sqlite3 {temp_path} 'SELECT name, value FROM cookies WHERE name LIKE \"%session%\" OR name LIKE \"%csrf%\" OR name LIKE \"%user%\" LIMIT 10;'" """,
            f"""su -c "sqlite3 {temp_path} '.schema'" """,
            f"""su -c "sqlite3 {temp_path} 'SELECT COUNT(*) FROM cookies;'" """
        ]
        
        for i, cmd in enumerate(sqlite_commands):
            result = run_cmd(["adb", "-s", udid, "shell", cmd], timeout=15)
            if result.strip() and "Error" not in result:
                print(f"      Query {i+1}: {result[:200]}...")
        
        # Ph∆∞∆°ng ph√°p 2: Strings analysis
        print("   üîç Method 2: Strings analysis...")
        strings_cmd = f"""su -c "strings {temp_path} | grep -E 'sessionid|csrftoken|instagram.com' | head -10" """
        strings_result = run_cmd(["adb", "-s", udid, "shell", strings_cmd], timeout=15)
        
        if strings_result.strip():
            print(f"      Strings: {strings_result[:300]}...")
        else:
            print("      ‚ùå Kh√¥ng t√¨m th·∫•y strings li√™n quan")
        
        # Ph∆∞∆°ng ph√°p 3: Hexdump analysis
        print("   üîç Method 3: Hexdump analysis...")
        hex_cmd = f"""su -c "hexdump -C {temp_path} | grep -i session | head -5" """
        hex_result = run_cmd(["adb", "-s", udid, "shell", hex_cmd], timeout=15)
        
        if hex_result.strip():
            print(f"      Hexdump: {hex_result[:200]}...")
        
        # Cleanup
        run_cmd(["adb", "-s", udid, "shell", "rm", "-f", temp_path], timeout=5)

def check_instagram_databases(udid: str):
    """Ki·ªÉm tra c√°c database c·ªßa Instagram"""
    print(f"\nüíæ PH√ÇN T√çCH DATABASES CHO: {udid}")
    print("=" * 70)
    
    db_path = "/data/data/com.instagram.android/databases"
    
    # Li·ªát k√™ databases
    db_list = run_cmd(["adb", "-s", udid, "shell", "su", "-c", f"ls -la {db_path}/"], timeout=10)
    print(f"üìã Databases:\n{db_list}")
    
    # T√¨m database c√≥ th·ªÉ ch·ª©a session data
    potential_dbs = []
    for line in db_list.split('\n'):
        if '.db' in line and any(keyword in line.lower() for keyword in ['user', 'session', 'auth', 'login']):
            db_name = line.split()[-1]
            potential_dbs.append(db_name)
    
    if not potential_dbs:
        # L·∫•y t·∫•t c·∫£ .db files
        for line in db_list.split('\n'):
            if '.db' in line and not line.startswith('d'):
                db_name = line.split()[-1] 
                potential_dbs.append(db_name)
    
    print(f"\nüéØ Analyzing {len(potential_dbs)} potential databases...")
    
    for db_name in potential_dbs[:5]:  # Gi·ªõi h·∫°n 5 database ƒë·∫ßu
        print(f"\nüìä Database: {db_name}")
        
        # Copy database ƒë·ªÉ ph√¢n t√≠ch
        temp_db = "/sdcard/temp_analysis.db"
        copy_cmd = f"""su -c "cp {db_path}/{db_name} {temp_db} && chmod 644 {temp_db}" """
        run_cmd(["adb", "-s", udid, "shell", copy_cmd], timeout=10)
        
        # L·∫•y schema
        schema_cmd = f"""su -c "sqlite3 {temp_db} '.schema' | head -20" """
        schema = run_cmd(["adb", "-s", udid, "shell", schema_cmd], timeout=10)
        
        if schema.strip():
            print(f"   Schema: {schema[:300]}...")
            
            # T√¨m b·∫£ng c√≥ th·ªÉ ch·ª©a session data
            session_tables = []
            for line in schema.split('\n'):
                if any(keyword in line.lower() for keyword in ['user', 'session', 'auth', 'login', 'token']):
                    if 'CREATE TABLE' in line.upper():
                        table_name = re.search(r'CREATE TABLE\s+(\w+)', line, re.IGNORECASE)
                        if table_name:
                            session_tables.append(table_name.group(1))
            
            # Query c√°c b·∫£ng quan tr·ªçng
            for table in session_tables[:3]:
                query_cmd = f"""su -c "sqlite3 {temp_db} 'SELECT * FROM {table} LIMIT 3;'" """
                query_result = run_cmd(["adb", "-s", udid, "shell", query_cmd], timeout=10)
                
                if query_result.strip() and "Error" not in query_result:
                    print(f"   Table {table}: {query_result[:150]}...")
        
        # Cleanup
        run_cmd(["adb", "-s", udid, "shell", "rm", "-f", temp_db], timeout=5)

def generate_detailed_report(udid: str):
    """T·∫°o b√°o c√°o chi ti·∫øt v√† ƒë·ªÅ xu·∫•t"""
    print(f"\nüìã B√ÅO C√ÅO CHI TI·∫æT CHO: {udid}")
    print("=" * 70)
    
    print("üîç T√ìM T·∫ÆT PH√ÇN T√çCH:")
    print("1. ‚úÖ Thi·∫øt b·ªã c√≥ quy·ªÅn root")
    print("2. ‚úÖ Instagram app ƒë√£ c√†i ƒë·∫∑t")
    print("3. ‚úÖ C√≥ nhi·ªÅu preference files (Instagram ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng)")
    print("4. ‚ö†Ô∏è Session cookies kh√¥ng t√¨m th·∫•y ·ªü v·ªã tr√≠ th√¥ng th∆∞·ªùng")
    
    print("\nüí° NGUY√äN NH√ÇN C√ì TH·ªÇ:")
    print("‚Ä¢ Instagram phi√™n b·∫£n m·ªõi c√≥ th·ªÉ thay ƒë·ªïi c√°ch l∆∞u cookies")
    print("‚Ä¢ Session cookies c√≥ th·ªÉ ƒë∆∞·ª£c m√£ h√≥a/obfuscated")
    print("‚Ä¢ Cookies c√≥ th·ªÉ ƒë∆∞·ª£c l∆∞u trong memory ho·∫∑c cache kh√°c")
    print("‚Ä¢ App c√≥ th·ªÉ s·ª≠ d·ª•ng native authentication thay v√¨ web cookies")
    
    print("\nüöÄ GI·∫¢I PH√ÅP ƒê·ªÄ XU·∫§T:")
    print("1. Th·ª≠ ƒëƒÉng xu·∫•t ho√†n to√†n Instagram v√† ƒëƒÉng nh·∫≠p l·∫°i")
    print("2. S·ª≠ d·ª•ng Instagram web trong browser tr√™n thi·∫øt b·ªã")
    print("3. Ki·ªÉm tra Chrome/WebView cookies cho instagram.com")
    print("4. S·ª≠ d·ª•ng network monitoring ƒë·ªÉ b·∫Øt cookies runtime")
    print("5. Th·ª≠ ph∆∞∆°ng ph√°p Frida hook ƒë·ªÉ intercept API calls")

if __name__ == "__main__":
    import sys
    
    # L·∫•y device ID t·ª´ argument ho·∫∑c auto detect
    if len(sys.argv) > 1:
        device_id = sys.argv[1]
    else:
        devices_output = run_cmd(["adb", "devices"])
        lines = [l for l in devices_output.splitlines() if l.strip()]
        devices = [ln.split("\t")[0] for ln in lines[1:] if "\tdevice" in ln]
        
        if not devices:
            print("‚ùå Kh√¥ng t√¨m th·∫•y thi·∫øt b·ªã")
            exit(1)
        
        device_id = devices[0]
        print(f"üì± S·ª≠ d·ª•ng thi·∫øt b·ªã: {device_id}")
    
    try:
        analyze_key_preference_files(device_id)
        extract_webview_cookies_advanced(device_id)
        check_instagram_databases(device_id)
        generate_detailed_report(device_id)
        
        print(f"\nüéØ NEXT STEPS:")
        print("1. Ch·∫°y: python deep_analysis.py {device_id} > analysis_report.txt")
        print("2. G·ª≠i report ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£ th√™m")
        print("3. Th·ª≠ c√°c gi·∫£i ph√°p ƒë·ªÅ xu·∫•t ·ªü tr√™n")
        
    except KeyboardInterrupt:
        print("\n‚èπÔ∏è ƒê√£ d·ª´ng ph√¢n t√≠ch")
    except Exception as e:
        print(f"\n‚ùå L·ªói: {e}")